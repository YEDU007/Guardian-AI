<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Guardian AI | Profile</title>
  <link rel="stylesheet" href="assets/styles.css">
</head>
<body>

<!-- Navbar -->
<div id="navbar-container"></div>
<script>
  fetch("components/navbar.html")
    .then(r => r.text())
    .then(html => {
      document.getElementById("navbar-container").innerHTML = html;
    });
</script>

<div class="card">
  <h2>ğŸ‘¤ Elderly Profile</h2>

  <h3>Personal Details</h3>
  <input id="name" placeholder="Full Name">
  <input id="age" type="number" placeholder="Age">
  <input id="gender" placeholder="Gender">
  <input id="bloodGroup" placeholder="Blood Group">
  <input id="address" placeholder="Address">

  <label>
    <input type="checkbox" id="livesAlone"> Lives Alone
  </label>

  <h3>ğŸ“ Emergency Contacts</h3>
  <div id="contactInputs"></div>

  <button type="button" onclick="addContact()">â• Add Contact</button>
  <button type="button" onclick="saveProfile()">ğŸ’¾ Save Profile</button>

  <hr>

  <h3>âœ… Saved Contacts</h3>
  <div id="savedContacts"></div>
</div>

<script type="module">
  import { auth, db } from "./firebase/firebase-config.js";
  import { onAuthStateChanged, signOut }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { doc, getDoc, setDoc }
    from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  let uid;
  const contactInputs = document.getElementById("contactInputs");
  const savedContacts = document.getElementById("savedContacts");

  // Utility: never return undefined
  const safe = v => v ?? "";

  function contactInput(c = {}) {
    return `
      <div class="contact-card">
        <input placeholder="Name" value="${safe(c.name)}">
        <input placeholder="Phone" value="${safe(c.phone)}">
        <input placeholder="Relationship" value="${safe(c.relationship)}">
      </div>
    `;
  }

  window.addContact = () => {
    contactInputs.insertAdjacentHTML("beforeend", contactInput());
  };

  onAuthStateChanged(auth, async user => {
    if (!user) return location.href = "index.html";
    uid = user.uid;

    const snap = await getDoc(doc(db, "users", uid));
    if (!snap.exists()) return;

    const d = snap.data();
    name.value = safe(d.name);
    age.value = safe(d.age);
    gender.value = safe(d.gender);
    bloodGroup.value = safe(d.bloodGroup);
    address.value = safe(d.address);
    livesAlone.checked = !!d.livesAlone;

    renderSavedContacts(d.emergencyContacts || []);
  });

  function renderSavedContacts(list) {
    savedContacts.innerHTML = "";
    list.forEach(c => {
      savedContacts.innerHTML += `
        <div class="alert-card">
          <strong>${safe(c.name)}</strong><br>
          ğŸ“ ${safe(c.phone)}<br>
          ğŸ¤ ${safe(c.relationship)}
        </div>
      `;
    });
  }

  window.saveProfile = async () => {
    try {
      const contacts = [...contactInputs.children].map(c => ({
        name: safe(c.children[0].value),
        phone: safe(c.children[1].value),
        relationship: safe(c.children[2].value)
      }));

      const data = {
        name: safe(name.value),
        age: safe(age.value),
        gender: safe(gender.value),
        bloodGroup: safe(bloodGroup.value),
        address: safe(address.value),
        livesAlone: livesAlone.checked,
        emergencyContacts: contacts
      };

      await setDoc(doc(db, "users", uid), data);

      renderSavedContacts(contacts);
      contactInputs.innerHTML = "";
      alert("Profile saved successfully");

    } catch (err) {
      alert("Save failed: " + err.message);
    }
  };

  window.logout = () =>
    signOut(auth).then(() => location.href = "index.html");
</script>

</body>
</html>
